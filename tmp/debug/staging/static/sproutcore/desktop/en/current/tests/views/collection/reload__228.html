<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <title>Sproutcore Desktop</title>
  <script type="text/javascript">
/* >>>>>>>>>> BEGIN source/core.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================


/* >>>>>>>>>> BEGIN source/system/browser.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

var SC = SC || { BUNDLE_INFO: {}, LAZY_INSTANTIATION: {} };

SC.browser = (function() {
  var userAgent = navigator.userAgent.toLowerCase();
  var version = (userAgent.match( /.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/ ) || [])[1] ;

  var browser = {
    version: version,
    safari: (/webkit/).test( userAgent ) ? version : 0,
    opera: (/opera/).test( userAgent ) ? version : 0,
    msie: (/msie/).test( userAgent ) && !(/opera/).test( userAgent ) ? version : 0,
    mozilla: (/mozilla/).test( userAgent ) && !(/(compatible|webkit)/).test( userAgent ) ? version : 0,
    mobileSafari: (/apple.*mobile.*safari/).test(userAgent) ? version : 0,
    windows: !!(/(windows)/).test(userAgent),
    mac: !!((/(macintosh)/).test(userAgent) || (/(mac os x)/).test(userAgent)),
    language: (navigator.language || navigator.browserLanguage).split('-', 1)[0]
  };
  
    browser.current = browser.msie ? 'msie' : browser.mozilla ? 'mozilla' : browser.safari ? 'safari' : browser.opera ? 'opera' : 'unknown' ;
  return browser ;
})();

/* >>>>>>>>>> BEGIN source/system/loader.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

SC.bundleDidLoad = function(bundle) {
  var info = this.BUNDLE_INFO[bundle] ;
  if (!info) info = this.BUNDLE_INFO[bundle] = {} ;
  info.loaded = true ;
};

SC.bundleIsLoaded = function(bundle) {
  var info = this.BUNDLE_INFO[bundle] ;
  return info ? !!info.loaded : false ;
};

SC.loadBundle = function() { throw "SC.loadBundle(): SproutCore is not loaded."; };

SC.setupBodyClassNames = function() {
  var el = document.body ;
  if (!el) return ;
  var browser, platform, shadows, borderRad, classNames, style;
  browser = SC.browser.current ;
  platform = SC.browser.windows ? 'windows' : SC.browser.mac ? 'mac' : 'other-platform' ;
  style = document.documentElement.style;
  shadows = (style.MozBoxShadow !== undefined) || 
                (style.webkitBoxShadow !== undefined) ||
                (style.oBoxShadow !== undefined) ||
                (style.boxShadow !== undefined);
  
  borderRad = (style.MozBorderRadius !== undefined) || 
              (style.webkitBorderRadius !== undefined) ||
              (style.oBorderRadius !== undefined) ||
              (style.borderRadius !== undefined);
  
  classNames = el.className ? el.className.split(' ') : [] ;
  if(shadows) classNames.push('box-shadow');
  if(borderRad) classNames.push('border-rad');
  classNames.push(browser) ;
  classNames.push(platform) ;
  if (SC.browser.msie==7) classNames.push('ie7') ;
  if (SC.browser.mobileSafari) classNames.push('mobile-safari') ;
  el.className = classNames.join(' ') ;
} ;

/* >>>>>>>>>> BEGIN bundle_loaded.js */
; if ((typeof SC !== 'undefined') && SC && SC.bundleDidLoad) SC.bundleDidLoad('sproutcore/bootstrap');

</script>

     <link href="/static/sproutcore/testing/en/current/stylesheet.css?1262955016" rel="stylesheet" type="text/css" />
  <link href="/static/sproutcore/foundation/en/current/stylesheet.css?1262955016" rel="stylesheet" type="text/css" />
  <link href="/static/sproutcore/desktop/en/current/stylesheet.css?1262955016" rel="stylesheet" type="text/css" />
   
    
  </head>
    
  <body class="sc-theme focus" style="overflow:hidden;" >  
<script type="text/javascript">
/* >>>>>>>>>> BEGIN source/setup_body_class_names.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

// sc_resource('setup_body_class_names'); // publish into inline format

if (SC.setupBodyClassNames) SC.setupBodyClassNames() ;


</script>


  <script type="text/javascript" src="/static/sproutcore/debug/en/current/javascript.js?1262955396"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/javascript.js?1262955396"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/javascript.js?1262955396"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/javascript.js?1262955396"></script>
  <script type="text/javascript" src="/static/sproutcore/foundation/en/current/javascript.js?1262955396"></script>
  <script type="text/javascript" src="/static/sproutcore/desktop/en/current/javascript.js?1262955396"></script>
<script type="text/javascript">String.preferredLanguage = "en";</script>
<script type="text/javascript">
if (typeof SC !== "undefined") {
  SC.mode = "TEST_MODE";
  SC.filename = "static/sproutcore/desktop/en/current/tests/views/collection/reload.js"; 
}
(function() {
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            portions copyright @2009 Apple Inc.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

var view, content ;

module("SC.CollectionView.reload", {
  setup: function() {
    content = "1 2 3 4 5 6 7 8 9 10".w().map(function(x) {
      return SC.Object.create({ value: x });
    });
    
    view = SC.CollectionView.create({
      content: content, 

      isVisibleInWindow: YES
    });
  }
});

/*
  Verfies that the item views for the passed collection view match exactly the
  content array passed.  If shouldShowAllContent is also YES then verifies 
  that the nowShowing range is showing the entire content range.
  
  @param {SC.CollectionView} view the view to test
  @param {SC.Array} content the content array
  @param {Boolean} shouldShowAllContent
  @param {String} testName optional test name
  @returns {void}
*/
function verifyItemViews(view, content, shouldShowAllContent, testName) {
  var nowShowing = view.get('nowShowing'),
      childViews = view.get('childViews');

  if (testName === undefined) testName='';
  
  if (shouldShowAllContent) {
    ok(nowShowing.isEqual(SC.IndexSet.create(0, content.get('length'))), '%@ nowShowing (%@) should equal (0..%@)'.fmt(testName, nowShowing, content.get('length')-1));
  }
  
  equals(childViews.get('length'), nowShowing.get('length'), '%@ view.childViews.length should match nowShowing.length'.fmt(testName));
  
  // childViews should be in same order as nowShowing indexes at all times.
  var iter= 0;
  nowShowing.forEach(function(idx) {
    var itemView = childViews.objectAt(iter),
        item     = content.objectAt(idx);
    ok(itemView, 'childViews[%@] should have itemView'.fmt(iter));
    if (itemView) {
      equals(itemView.get('content'), item, '%@ childViews[%@].content should equal content[%@]'.fmt(testName, iter,idx));
    }
    iter++;    
  });
}

// ..........................................................
// BASIC TESTS
// 

test("should only reload when isVisibleInWindow", function() {

  view.set('isVisibleInWindow', NO);
  //view.isVisibleInWindow = NO ;
  
  var len = view.getPath('childViews.length');
  
  SC.run(function() {
    view.reload();
  });

  equals(view.getPath('childViews.length'), len, 'view.childViews.length should not change while offscreen');
  
  SC.RunLoop.begin();
  view.set('isVisibleInWindow', YES);
  SC.RunLoop.end();

  equals(view.getPath('childViews.length'), content.get('length'), 'view.childViews.length should change when moved onscreen if reload is pending');
});

test("should automatically reload if content is set when collection view is first created", function() {
  ok(view.get('content'), 'precond - should have content');
  SC.RunLoop.begin();
  SC.RunLoop.end();

  verifyItemViews(view, content, YES);
});

test("reload(null) should generate item views for all items", function() {

  SC.RunLoop.begin();
  view.reload();
  SC.RunLoop.end(); // allow reload to run

  verifyItemViews(view, content, YES);
});

test("reload(index set) should update item view for items in index only", function() {

  // make sure views are loaded first time
  SC.run(function() { view.reload(); });
  
  // now get a couple of child views.
  var cv1 = view.childViews[1], cv2 = view.childViews[3];
  
  // and then reload them
  SC.run(function() { view.reload(SC.IndexSet.create(1).add(3)); });
  
  ok(cv1 !== view.childViews[1], 'view.childViews[1] should be new instance after view.reload(<1,3>) actual: %@ expected: %@'.fmt(view.childViews[1], cv1));
  ok(cv2 !== view.childViews[3], 'view.childViews[3] should be new instance after view.reload(<1,3>) actual: %@ expected: %@'.fmt(view.childViews[3], cv2));
  
  // verify integrity
  verifyItemViews(view, content, YES);
});

test("adding items to content should reload item views at end", function() {

  SC.run(function() { 
    content.pushObject(SC.Object.create()); 
  });
  verifyItemViews(view, content, YES);
});

test("removing items from content should remove item views", function() {

  SC.run(function() { 
    content.popObject(); 
  });
  verifyItemViews(view, content, YES);
});

// ..........................................................
// SPECIAL CASES
// 

test("remove and readd item", function() {
  // first remove an item.
  var item = content.objectAt(0);
  SC.run(function() { content.removeAt(0); });
  verifyItemViews(view, content, YES, 'after content.removeAt(0)');

  // then readd the item
  SC.run(function() { content.insertAt(0, item); });
  verifyItemViews(view, content, YES, 'after content.insertAt(0,item)');

  // then add another item
  item = SC.Object.create();
  SC.run(function() { content.pushObject(item); });
  verifyItemViews(view, content, YES, 'after content.pushObject(item)');

  // and remove the item
  SC.run(function() { content.popObject(); });
  verifyItemViews(view, content, YES, 'after content.popObject(item)');

});

test("reloading should only render nowShowing component", function() {
  var expected = SC.IndexSet.create(0,2).add(6);

  view = SC.CollectionView.create({
    content: content, 
    computeNowShowing: function() {
      return expected;
    },
    isVisibleInWindow: YES
  });
  
  SC.RunLoop.begin();
  view.reload();
  SC.RunLoop.end();
  
  same(view.get('nowShowing'), expected, 'precond - should have limited now showing');
  equals(view.get('childViews').get('length'), expected.get('length'), 'should only render number of child views in IndexSet');
});
})();
</script>
	</body>
</html>
